/* =========================================================
 * bootstrap-gtreetable.min.js 1.2a
 * http://gtreetable.gilek.net
 * =========================================================
 * Copyright 2014 Maciej "Gilek" KÅ‚ak
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * ========================================================= */
!function(e){var t=function(t,n){this.options=e.extend({},e.fn.gtreetable.defaults,n);var r=this.options.languages[this.options.language]===undefined?this.options.languages["en"]:this.options.languages[this.options.language];if(this.options.template===undefined){var i='<table class="table gtreetable">'+'<tr class="node node-collapsed">'+"<td>"+'<span><span class="node-indent"></span><i class="node-icon glyphicon glyphicon-chevron-right"></i><i class="node-icon-selected glyphicon glyphicon-ok"></i><span class="node-name"></span></span>'+'<span class="hide node-action">'+'<input type="text" name="name" value="" style="width: '+this.options.inputWidth+'" class="form-control" />'+'<button type="button" class="btn btn-sm btn-primary node-save">'+r.save+"</button> "+'<button type="button" class="btn btn-sm node-saveCancel">'+r.cancel+"</button>"+"</span>"+'<div class="btn-group pull-right">'+'<button type="button" class="btn btn-sm btn-default dropdown-toggle node-actions" data-toggle="dropdown">'+r.action+' <span class="caret"></span>'+"</button>"+'<ul class="dropdown-menu" role="menu">'+'<li role="presentation" class="dropdown-header">'+r.action+"</li>";this.actions=new Array;if(this.options.defaultActions!==null)this.actions=this.options.defaultActions;if(this.options.actions!==undefined)this.actions.push.apply(this.actions,this.options.actions);e.each(this.actions,function(e,t){var n=t.name.match(/\{(.+)\}/);var s=n!==null&&n[1]!==undefined&&r[n[1]]!==undefined?r[n[1]]:t.name;i+='<li role="presentation"><a href="#notarget" class="node-action-'+e+'" tabindex="-1">'+s+"</a></li>"});i+="</ul>"+"</div>"+"</td>"+"</tr>"+"</table>";this.options.template=i}this.cache=new Array;this.$tree=t;if(!this.$tree.find("tbody").length===0)this.$tree.append("<tbody></tbody>");if(!this.options.readonly){this.$tree.addClass("gtreetable-fullAccess")}this.$nodeTemplate=e(this.options.templateSelector?this.options.templateSelector:this.options.template).find(".node")};t.prototype={init:function(e){this.fillNodes(e===undefined?0:e,this)},getNode:function(e){return this.$tree.find(".node"+e)},getNodeLastChild:function(t){var n=undefined;e.each(this.getNode(t).nextAll(".node"),function(r,i){var i=e(i);if(i.data("parent")===t){n=i}else{return n}});return n},getSelected:function(){return this.$tree.find(".node-selected")},getSelectedId:function(){var e=this.getSelected();return e.data("id")},getSelectedPath:function(){var t=this.getSelected();if(!t)return t;var n=[t.find(".node-name").html()],r=t.data("parent");t.prevAll(".node").each(function(){var t=e(this);if(t.data("id")===r){r=t.data("parent");n[n.length]=t.find(".node-name").html()}});return n},renderNode:function(t){var n=this;var r=n.$nodeTemplate.clone(false);r.find(".node-name").html(t.name);if(t.id!==undefined){r.data("id",t.id);r.addClass("node"+t.id);r.addClass("node-saved")}r.data("parent",t.parent);r.data("level",t.level);r.find(".node-indent").css("marginLeft",parseInt(t.level)*n.options.nodeIndent+"px").html("&zwnj;");r.mouseover(function(){e(this).addClass("node-hovered")});r.mouseleave(function(){e(this).removeClass("node-hovered");e(this).find(".btn-group").removeClass("open")});r.find(".node-name").click(function(){n.$tree.find(".node-selected").removeClass("node-selected");var t=e(this).parents(".node");t.addClass("node-selected");if(e.isFunction(n.options.onSelect)){n.options.onSelect(t,n)}});r.find(".node-icon").click(function(e){if(r.hasClass("node-collapsed"))n.expandNode(t.id,{isAltPressed:e.altKey});else n.collapseNode(t.id)});e.each(this.actions,function(e,t){r.find(".node-action-"+e).click(function(){t.event(r,n)})});r.find(".node-save").click(function(){n.saveNode(r)});r.find(".node-saveCancel").click(function(){n.saveCancelNode(r)});return r},appendNode:function(e){if(this.$tree.find(".node").length===0)this.$tree.append(e);else{var t=this.getNodeLastChild(e.data("parent"));if(t===undefined)t=this.getNode(e.data("parent"));t.after(e)}},addNode:function(e){var t=this;e.find(".node-icon").css("visibility","visible");var n=t.renderNode({level:parseInt(e.data("level"))+1,parent:e.data("id")});n.find(".node-action").removeClass("hide");t.expandNode(n.data("parent"),{onAfterFill:function(e){e.appendNode(n)}})},updateNode:function(e){var t=e.find(".node-name");e.find("input").val(t.html());t.addClass("hide");e.find(".node-action").removeClass("hide")},removeNode:function(t){var n=this;if(t.hasClass("node-saved")){if(e.isFunction(n.options.onDelete))e.when(n.options.onDelete(t)).done(function(e){delete n.cache[t.data("parent")];if(!(t.prev(".node").data("parent")===t.data("parent")||t.next(".node").data("parent")===t.data("parent")))n.collapseNode(t.data("parent"));else n._removeNode(t.data("id"))})}else{t.remove()}},_removeNode:function(e){this.removeChildNodes(e);this.getNode(e).remove()},removeChildNodes:function(t){var n=this.getNode(t);var r=n.nextAll(".node");for(var i in r){var s=e(r[i]);if(s.data("level")>n.data("level"))s.remove();else break}},saveNode:function(t){var n=this;if(e.isFunction(n.options.onSave))e.when(n.options.onSave(t)).done(function(e){delete n.cache[t.data("parent")];var r=t.find(".node-action");t.find(".node-name").html(r.find("input").val()).removeClass("hide");r.addClass("hide");if(!t.hasClass("node-saved")){t.data("id",e.id);t.addClass("node"+e.id);t.addClass("node-saved")}})},saveCancelNode:function(e){if(e.hasClass("node-saved")){e.find(".node-action").addClass("hide");e.find(".node-name").removeClass("hide")}else{var t=this.getNode(e.data("parent"));if(e.prev(".node").data("parent")===t.data("id"))e.remove();else this.collapseNode(t.data("id"))}},collapseNode:function(e){this.removeChildNodes(e);this.getNode(e).removeClass("node-expanded").addClass("node-collapsed")},expandNode:function(e,t){var n=this.getNode(e);if(!n.hasClass("node-expanded")){this.getNode(e).removeClass("node-collapsed").addClass("node-expanded");this.fillNodes(e,t)}else if(t&&typeof t.onAfterFill==="function")t.onAfterFill(this)},fillNodes:function(t,n){var r=this;if(r.options.cache&&r.cache[t]&&!n.isAltPressed){r._fillNodes(t,n)}else{e.when(r.getSourceNodes(t,r)).done(function(e){r._fillNodes(t,n)})}},_fillNodes:function(e,t){for(x=0;x<this.cache[e].length;x++){var n=this.renderNode(this.cache[e][x]);var r=this.cache[n.data("id")];if(r&&r.length===0&&!t.isAltPressed)n.find(".node-icon").css("visibility","hidden");this.appendNode(n)}if(t&&typeof t.onAfterFill==="function")t.onAfterFill(this);var i=this.getNode(e);if(i.next(".node").data("parent")!==e)i.find(".node-icon").css("visibility","hidden")},getSourceNodes:function(t,n){return e.ajax({type:"GET",url:n.options.source(t),dataType:"json",beforeSend:function(){n.getNode(t).find(".node-name").addClass(n.options.loadingClass)},success:function(e){for(x=0;x<e.length;x++)e[x].parent=t;n.cache[t]=e},error:function(e){alert(e.status+": "+e.responseText)},complete:function(){n.getNode(t).find(".node-name").removeClass(n.options.loadingClass)}})}};e.fn.gtreetable=function(n){return this.each(function(){var r=e(this),i=r.data("gtreetable");if(!i){if(r[0].tagName==="TABLE"){var i=new t(e(this),n);r.data("gtreetable",i);i.init()}}})};e.fn.gtreetable.defaults={nodeIndent:16,language:"en",languages:{en:{save:"Save",cancel:"Cancel",action:"Action",actionAdd:"Add",actionEdit:"Edit",actionDelete:"Delete"}},defaultActions:[{name:"{actionAdd}",event:function(e,t){t.addNode(e)}},{name:"{actionEdit}",event:function(e,t){t.updateNode(e)}},{name:"{actionDelete}",event:function(e,t){t.removeNode(e)}}],loadingClass:"node-loading",inputWidth:"60%",readonly:false,cache:true}}(jQuery)
